<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Performance: C++/CLI vs COM &middot; Paul
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Paul
        </a>
      </h1>
      <a href="https://twitter.com/pauldotknopf" target="_blank">@pauldotknopf</a>
      <p class="lead">Random thoughts and ideas of a software developer.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive/">Archive</a>
          
        
      
        
      
        
          
        
      
        
      
        
      

    </nav>

    <p>&copy; 2016. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Performance: C++/CLI vs COM</h1>
  

<div class="post-links">
  <span class="post-date"><i class="fa fa-calendar-o fa-1" aria-hidden="true"></i> 07 Mar 2013</span>
  <span class="post-edit"><i class="fa fa-pencil-square-o fa-1" aria-hidden="true"></i> 

<a href="https://github.com/pauldotknopf/pauldotknopf.github.io/edit/master/blog/_posts/2013-03-07-Performance-CPP-CLI-vs-COM.md">edit</a>
</span>
  



<span class="post-comments"><i class="fa fa-comment-o fa-1" aria-hidden="true"></i> <a href="#disqus_thread" data-disqus-identifier="post-1053">comments</a></span>

</div>

  <p>In my current project, we are going to require a great deal of native code due to interation with drivers and hardware. The application is going to be based in .NET, at least the UI portion, but the heart has to live in native C++.</p>

<p>I began investigating different ways to interop with .NET and unmanaged code. There seems to be three approaches.</p>

<ol>
  <li>PInvoke</li>
  <li>COM/COM+/Interop</li>
  <li>C++/CLI</li>
</ol>

<p>I did not look into the PInvoke method because I know that it will not be suitable for my needs. Things get complicated really quick with PInvoke. It is ideal for small/quick access to Win32, but not beyond that. With that said, I produced some metrics about the performance between COM+ and C++/CLI.</p>

<p>I have one class (unmanaged) that I use in every metric.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="cp">#pragma once
</span><span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="k">class</span> <span class="nc">NativeClass</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
	<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="n">NativeClass</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="o">~</span><span class="n">NativeClass</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kr">__declspec</span><span class="p">(</span><span class="n">dllexport</span><span class="p">)</span> <span class="kt">int</span> <span class="n">GetWindowsVersion</span><span class="p">(</span><span class="kt">int</span> <span class="n">numberOfExecutions</span><span class="p">);</span>
<span class="p">};</span></code></pre></figure>

<p>There are duplications of this class but they all do the same thing. The method we are testing is a simple GetVersionEx from the WinAPI.</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><span class="kt">int</span> <span class="n">NativeClass</span><span class="o">::</span><span class="n">GetWindowsVersion</span><span class="p">(</span><span class="kt">int</span> <span class="n">numberOfExecutions</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">OSVERSIONINFO</span> <span class="n">osvi</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">numberOfExecutions</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">ZeroMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osvi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">OSVERSIONINFO</span><span class="p">));</span>
		<span class="n">osvi</span><span class="p">.</span><span class="n">dwOSVersionInfoSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">OSVERSIONINFO</span><span class="p">);</span>
		<span class="n">GetVersionEx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">osvi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">osvi</span><span class="p">.</span><span class="n">dwBuildNumber</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>The parameter “numberOfExecutions” tells the unmanaged class how many times it should invoke GetVersionEx. This native class is written/duplicated in multiple projects to similate the same process. I have 4 projects.</p>

<ol>
  <li>PerformanceTest - This is a console application that runs the performance in C#/.NET</li>
  <li>CLITest - This is a C++/CLI project that contains two classes.
The first class is a wrapper around an unmanaged class that is compiled in the same C++/CLI project.
The second class is a wrapper around an unmanaged class that is compiled in a seperate native dll (not C++/CLI).</li>
  <li>COMTest - This is a project that has a COM wrapper around an unmanaged class.</li>
</ol>

<p>I tested two scenarios.</p>

<ol>
  <li>Calling an unmanaged class from .NET multiple times.</li>
  <li>Calling an unmanaged class from .NET a single time while doing a large task (numberOfExecutions = 10000000).</li>
</ol>

<p>Here are the results from the console application for the 3 situations.</p>

<ol>
  <li>.NET to CLI calling an unmanaged class compiled in C++/CLI.</li>
  <li>.NET to CLI calling an unmanaged class compiled in native C++.</li>
  <li>.NET to COM calling an unmanaged class compiled in native C++.</li>
</ol>

<p>Here is the output of the test.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>CLI..........................
     GetWindowsVersion:
         Calls: 100000
         Executions: 1
         Result: 00:00:00.0190000
     GetWindowsVersion:
         Calls: 1
         Executions: 100000000
         Result: 00:00:15.7790000
CLI to native................
     GetWindowsVersion:
         Calls: 100000
         Executions: 1
         Result: 00:00:00.0180000
     GetWindowsVersion:
         Calls: 1
         Executions: 100000000
         Result: 00:00:04.8020000
COM..........................
     GetWindowsVersion:
         Calls: 100000
         Executions: 1
         Result: 00:00:02.6120000
     GetWindowsVersion:
         Calls: 1
         Executions: 100000000
         Result: 00:00:04.7310000
</code></pre>
</div>

<h2 id="conclusion">Conclusion</h2>

<p>Native code compiled and running under C++/CLI is a great deal slower than running pure native code. COM would be the obviouse choice due to it running pure unmanaged code, but C++/CLI can give the same performance if used as a wrapper around a pure native assembly. In addition, COM/ATL is very difficult to learn, however, Visual Studio’s class wizards make it easier. Also, it seems that, making a great deal of calls to native code is MUCH more efficient through C++/CLI as opposed to COM, but this may be an unlikely scenario. Given these results and given the fact that this native code I am writing will be written primarily for .NET (as opposed to COM/activex/etc), I would recommend using the C++/CLI wrapper approach. Same performance, more flexible interop.</p>

<p>The project used for running these tests can be found on github <a href="https://github.com/theonlylawislove/CLICOMPerformanceTest">here</a>.</p>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/development/2013/01/26/why-you-should-avoid-ektron/">
            Why you should avoid Ektron
            <small>26 Jan 2013</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

<div class="comments">
	<h2>Comments</h2>
	<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_identifier = 'post-1053';
  var disqus_title = 'Performance: C++/CLI vs COM';
  var disqus_url = 'http://www.pknopf.com///development/2013/03/07/Performance-CPP-CLI-vs-COM/';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//pknopf.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>

    </div>

    <script id="dsq-count-scr" src="//pknopf.disqus.com/count.js" async></script>
    <script>
	  	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  		ga('create', 'UA-33707123-1', 'auto');ga('send', 'pageview');
	  </script>
  </body>
</html>
