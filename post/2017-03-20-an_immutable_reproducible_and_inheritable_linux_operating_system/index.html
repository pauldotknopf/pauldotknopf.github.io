<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>An immutable, reproducible and inheritable Linux operating system. - Paul Knopf</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="/dist/styles.css" rel="stylesheet" type="text/css"/>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112478642-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-112478642-1');
  </script>
</head>
<body>
<header class="bg-light mb-3">
  <div class="navbar navbar-expand">
    <div class="container">
      <a href="/" class="navbar-brand d-flex">
        <strong>paul knopf</strong>
      </a>
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/archive">archive</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/about">about</a>
        </li>
      </ul>
    </div>
  </div>
</header>
<main>
  
<div class="container">
    <div class="post">
        <h1 class="title">
            An immutable, reproducible and inheritable Linux operating system.
        </h1>
        <p class="submitted">
            posted on Sep 20, 2017
        </p>
        <div class="content">
            <p><em><strong>Be warned</strong>! This is just &quot;thought-experiment&quot; post. Nothing has been tried or tested.</em></p>
<h1 id="my-problem">My problem</h1>
<p>I have multiple computers. Each system has a different OS (or version) and configuration. One has Ubuntu 14, the others have Ubuntu 16. Some have had their packages updated, some have been neglected. Some are using NVIDIA graphics, others onboard Intel graphics.</p>
<p>The context switching from machine-to-machine for simple tasks is mind numbing.</p>
<p>Is Qt Creator installed? If so, what version of Qt? Why does my compilation fail at home, but not at work? Old gcc? The list goes on.</p>
<h1 id="what-i-want">What I want</h1>
<h2 id="inheritance">Inheritance</h2>
<p>I would like to treat my operating system like inheritance in OOP. Here is my pseudo code to illustrate.</p>
<pre><code class="language-csharp hljs"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BaseImage</span>
{
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Install</span>(<span class="hljs-params"></span>)</span>;

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Run</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> command</span>)
    </span>{
        <span class="hljs-comment">// Run "command" in your operating system.</span>
        <span class="hljs-comment">// This command could be shell scripts, apt-get/pacman commands, etc.</span>
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Arch64</span> : <span class="hljs-title">BaseImage</span>
{
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Install</span>(<span class="hljs-params"></span>)
    </span>{
        Run(<span class="hljs-string">"./install-arch-rootfs.sh"</span>);
    }
}
    
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">NVidia</span> : <span class="hljs-title">Arch64</span>
{
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Install</span>(<span class="hljs-params"></span>)
    </span>{
        Run(<span class="hljs-string">"./install-nvidia-drivers.sh"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Development</span> : <span class="hljs-title">NVidia</span>
{
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Install</span>(<span class="hljs-params"></span>)
    </span>{
        Run(<span class="hljs-string">"./install-devtools.sh"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Gaming</span> : <span class="hljs-title">NVidia</span>
{
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Install</span>(<span class="hljs-params"></span>)
    </span>{
        Run(<span class="hljs-string">"./install-stream.sh"</span>);
    }
}</code></pre>
<p>I'd imagine building these images with something like this.</p>
<pre><code class="language-bash hljs">&gt; build --<span class="hljs-built_in">type</span> Gaming --output gaming.squashfs</code></pre>
<p>Notice the <code>squashfs</code> extension, which brings me to my next point.</p>
<h2 id="temporary-boots">Temporary boots</h2>
<p>When I boot images, I'd like all changes made to my operating system to be discarded after boot. This would allow me to test new packages with no fear that it will break my system.</p>
<p>Theoretically, Linux would mount <code>gaming.squashfs</code> at <code>/</code> on boot. The <code>squashfs</code> file system is read-only. To make <code>/</code> writable, we would have to overlay <code>tmpfs</code> on <code>/</code>, which would make all changes in <code>/</code> happen in RAM, wiping itself clean on fresh boot.</p>
<p>This would have also have a positive side effect of <em>forcing</em> you to capture all your operating system changes via your build scripts.</p>
<h1 id="proposal">Proposal</h1>
<h2 id="operating-system">Operating system</h2>
<p>I'm a fan of Arch Linux. It gives you a lot of control and bleeding edge packages (via AUR). I haven't jumped aboard though because of the level of maintenance that has to be done, especially if your <code>pacman -Syu</code> breaks your install. Bleeding edge can bleed a little.</p>
<h2 id="building-and-inheritance">Building and inheritance</h2>
<p>So, how do I build a an Arch rootfs while also allowing me to inherit &quot;layers&quot; from each other?</p>
<p>Docker.</p>
<pre><code class="language-dockerfile hljs"><span class="hljs-comment"># my-base - Packages that I want present on all systems.</span>
<span class="hljs-keyword">FROM</span> base/archlinux
<span class="hljs-comment"># Update everything</span>
<span class="hljs-keyword">RUN</span><span class="bash"> pacman -Syu
</span><span class="hljs-comment"># Enable the AUR</span>
<span class="hljs-keyword">RUN</span><span class="bash"> pacman -S yaourt
</span><span class="hljs-comment"># Use KDE</span>
<span class="hljs-keyword">RUN</span><span class="bash"> pacman -S plasma-meta
</span><span class="hljs-comment"># Install Google Chrome</span>
<span class="hljs-keyword">RUN</span><span class="bash"> pacman -S google-chrome</span></code></pre>
<pre><code class="language-dockerfile hljs"><span class="hljs-comment"># my-base-nvidia - My base image with NVidia layered on top.</span>
<span class="hljs-keyword">FROM</span> my-base
<span class="hljs-comment"># Install NVidia drivers</span>
<span class="hljs-keyword">RUN</span><span class="bash"> pacman -S nvidia-dkms </span></code></pre>
<pre><code class="language-dockerfile hljs"><span class="hljs-comment"># my-development - My development machine that has a NVidia graphics card.</span>
<span class="hljs-keyword">FROM</span> my-base-nvidia
<span class="hljs-comment"># Install dev tools</span>
<span class="hljs-keyword">RUN</span><span class="bash"> pacman -S base-devel</span></code></pre>
<pre><code class="language-dockerfile hljs"><span class="hljs-comment"># my-gaming - My gaming machine, which also has a NVidia graphics card.</span>
<span class="hljs-keyword">FROM</span> my-base-nvidia
<span class="hljs-keyword">RUN</span><span class="bash"> pacman -S steam</span></code></pre>
<blockquote>
<p>What? How do you expect to boot these docker images on bare-metal?</p>
</blockquote>
<p>Well, yeah. You can't. However, Arch has support for preparing rootfs file systems on any Linux machine, provided you have the <code>arch-chroot</code> bash script is installed. This can be done in Docker.</p>
<p>So, I imagine creating a base <code>arch-rootfs</code> Docker image that contains a clean rootfs and <code>arch-chroot</code> available for customization.</p>
<pre><code class="language-dockerfile hljs"><span class="hljs-comment"># arch-rootfs</span>
<span class="hljs-keyword">FROM</span> base/archlinux
<span class="hljs-comment"># Install arch-chroot</span>
<span class="hljs-keyword">RUN</span><span class="bash"> arch-install-scripts
</span><span class="hljs-comment"># Create our rootfs directory</span>
<span class="hljs-keyword">RUN</span><span class="bash"> mkdir /rootfs
</span><span class="hljs-comment"># Populate our rootfs with a base Arch install</span>
<span class="hljs-keyword">RUN</span><span class="bash"> <span class="hljs-built_in">cd</span> /rootfs &amp;&amp;
</span>    curl -O https://arch.com/root.tar.gz &amp;&amp;
    tar xzf root.tar.gz</code></pre>
<p>Now we will have to add some additional commands to our layers.</p>
<pre><code class="language-dockerfile hljs"><span class="hljs-keyword">FROM</span> arch-rootfs
<span class="hljs-comment"># Update everything</span>
<span class="hljs-keyword">RUN</span><span class="bash"> arch-chroot /rootfs pacman -Syu
</span><span class="hljs-comment"># Enable the AUR</span>
<span class="hljs-keyword">RUN</span><span class="bash"> arch-chroot /rootfs pacman -S yaourt
</span><span class="hljs-comment"># Use KDE</span>
<span class="hljs-keyword">RUN</span><span class="bash"> arch-chroot /rootfs pacman -S plasma-meta
</span><span class="hljs-comment"># Install Google Chrome</span>
<span class="hljs-keyword">RUN</span><span class="bash"> arch-chroot /rootfs pacman -S google-chrome</span></code></pre>
<p>It isn't exactly clean, but it will work.</p>
<blockquote>
<p>How will you extract the /rootfs for booting?</p>
</blockquote>
<pre><code>docker save my-gaming &gt; my-gaming.tar
</code></pre>
<p>Within this tarball is a <code>/rootfs</code> directory containing our image. We will want to eventually convert this to a <code>squashfs</code> file.</p>
<p>To use boot these <code>squashfs</code> images, we would have to install Arch the normal way. Then customize the initcpio with some <a href="https://wiki.archlinux.org/index.php/mkinitcpio#Runtime_hooks">runtime hooks</a> that will mount <code>squashfs</code> images, overlay <code>tempfs</code> on <code>/</code>, <code>chroot</code> into the new root, and call <code>init</code>.</p>
<h2 id="image-storage">Image storage</h2>
<p>The docker files that build my layers will be checked into a GitHub repository. Travis-CI will monitor checkins, rebuild and deploy my images/layers to Docker Hub. I will use Docker Hub to make my builds available easily to all my machines.</p>
<p>I can also imagine many people using this approach, allowing people to quickly boot into stranger's operating systems to play around and experiment. For example:</p>
<pre><code class="language-bash hljs"><span class="hljs-comment"># Checkout and build some guy named Steve's gaming build.</span>
build steve/gaming
<span class="hljs-comment"># And reboot into it!</span>
boot steve/gaming
reboot now</code></pre>
<p>Now you are playing around in someone else's configuration! Fun!</p>
<p>Let's get back to our build.</p>
<pre><code class="language-bash hljs">boot paul/gaming
reboot now</code></pre>
<h1 id="in-summary">In summary</h1>
<ul>
<li>Reproducible builds of Arch Linux, using Docker.</li>
<li>Inheritance of Arch layers, using Docker.</li>
<li>Conversion of Docker images to <code>squashfs</code> files for read-only booting.</li>
<li>Mounting <code>tempfs</code> on <code>/</code> for writes that persist only during the current boot.</li>
<li>Storing images on Docker Hub for using in other machines, or by complete strangers!</li>
</ul>
<p>What do you think?</p>

        </div>
            <hr />
            <h3>Comments</h3>
                <p class="text-muted">
                    There are no comments yet.
                </p>
            <p class="text-center">
                <a class="btn btn-primary btn-light btn-lg" target="_blank" href="https://github.com/pauldotknopf/pauldotknopf.github.io/issues/4#new_comment_field"><i class="fab fa-github"></i> Join the discussion at GitHub</a>
            </p>
    </div>
</div>
</main>
<footer class="bg-light py-3 mt-5 text-muted text-center">
  <a href="https://github.com/pauldotknopf/pauldotknopf.github.io"><i class="fab fa-github"></i> source</a>
</footer>
<script src="/dist/scripts.js"></script>
</body>
</html>
