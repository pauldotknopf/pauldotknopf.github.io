<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Introducing Darch, a tool for building immutable, reproducable, and stateless bootable Linux images. Think docker, but for bare-metal.</title>
  <meta property="og:title" content="Introducing Darch, a tool for building immutable, reproducable, and stateless bootable Linux images. Think docker, but for bare-metal." />
  <meta name="twitter:title" content="Introducing Darch, a tool for building immutable, reproducable, and …" />
  <meta name="description" content="GitHub Project
I have previously blogged about my desire to have a &ldquo;docker-like&rdquo; environment for build images that I can boot bare-metal.
With that said, I created Darch.
What it is Darch is an application (written in golang) that makes building and booting rootfs images simple. It will generate rootfs.squash files and update grub.cfg for booting them. Even though Darch supports Arch only (Gentoo/VoidLinux soon), you can build and boot the images from any operating system that has grub installed.">
  <meta property="og:description" content="GitHub Project
I have previously blogged about my desire to have a &ldquo;docker-like&rdquo; environment for build images that I can boot bare-metal.
With that said, I created Darch.
What it is Darch is an application (written in golang) that makes building and booting rootfs images simple. It will generate rootfs.squash files and update grub.cfg for booting them. Even though Darch supports Arch only (Gentoo/VoidLinux soon), you can build and boot the images from any operating system that has grub installed.">
  <meta name="twitter:description" content="GitHub Project
I have previously blogged about my desire to have a &ldquo;docker-like&rdquo; environment for build images that I can boot bare-metal.
With that said, I created Darch.
What it is Darch …">
  <meta name="author" content="Paul Knopf"/>
  <meta property="og:image" content="https://www.pknopf.com/img/avatar-icon.png" />
  <meta name="twitter:image" content="https://www.pknopf.com/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://www.pknopf.com/post/2018-01-14-introducing_darch_a_tool_for_building_immutable_reproducable_stateless_linux_images_docker_for_base_metal/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Paul Knopf" />

  <meta name="generator" content="Hugo 0.32.3" />
  <link rel="canonical" href="https://www.pknopf.com/post/2018-01-14-introducing_darch_a_tool_for_building_immutable_reproducable_stateless_linux_images_docker_for_base_metal/" />
  <link rel="alternate" href="https://www.pknopf.com/index.xml" type="application/rss+xml" title="Paul Knopf">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://www.pknopf.com/css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://www.pknopf.com/css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://www.pknopf.com/css/highlight.min.css" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://www.pknopf.com/">Paul Knopf</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Paul Knopf" href="https://www.pknopf.com/">
            <img class="avatar-img" src="https://www.pknopf.com/img/avatar-icon.png" alt="Paul Knopf" />
          </a>
        
      </div>
    </div>

  </div>
</nav>




    





  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Introducing Darch, a tool for building immutable, reproducable, and stateless bootable Linux images. Think docker, but for bare-metal.</h1>
                
                
                  <span class="post-meta">
  Posted on January 14, 2018
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        

<p><a href="https://github.com/pauldotknopf/darch">GitHub Project</a></p>

<p>I have <a href="https://www.pknopf.com/post/2017-03-20-an_immutable_reproducible_and_inheritable_linux_operating_system/">previously blogged</a> about my desire to have a &ldquo;docker-like&rdquo; environment for build images that I can boot bare-metal.</p>

<p>With that said, I created <a href="https://github.com/pauldotknopf/darch">Darch</a>.</p>

<h1 id="what-it-is">What it is</h1>

<p>Darch is an application (written in golang) that makes building and booting rootfs images simple. It will generate <code>rootfs.squash</code> files and update <code>grub.cfg</code> for booting them. Even though Darch supports Arch only (Gentoo/VoidLinux soon), you can build and boot the images from any operating system that has grub installed.</p>

<p>During boot, a set of hooks are ran (see <a href="https://github.com/pauldotknopf/darch/tree/develop/scripts/hooks">here</a>) in initcpio that will prepare things like <code>/etc/fstab</code> and <code>/etc/hostname</code>.</p>

<p>See <a href="https://github.com/pauldotknopf/darch-images">here</a> for my image repository. It is setup with Travis-CI to auto-deploy to DockerHub, where my bootable images are deployed to. Darch supports pulling from DockerHub to boot images locally.</p>

<h1 id="steps-to-get-started">Steps to get started</h1>

<p>First, <a href="https://github.com/pauldotknopf/darch#install">install Darch</a>, then&hellip;</p>

<pre><code># Build the images. This generates local Docker images.
darch build $(darch build-dep)
# Extract Docker image to local file system.
darch stage upload plasma
# This effectively calls grub-mkconfig.
darch stage sync-boot-loader
</code></pre>

<p>Then, reboot into grub, and you will see a new menu entry for your Darch image.</p>

<h1 id="hooks">Hooks</h1>

<p>Images need to have certain machine-specific configurations. Out of the box, there are hooks for <code>/etc/fstab</code> and <code>/etc/hostname</code>. When images are uploaded to the stage, the hooks are ran against it (<code>darch stage run-hooks</code> to re-run them).</p>

<h2 id="fstab">fstab</h2>

<pre><code class="language-bash">darch hooks help fstab
</code></pre>

<ol>
<li>Create a <code>/var/darch/hooks/fstab.config</code> file.</li>
<li>The file is a list of <code>image-name=value</code> entries, where <code>image-name</code> is a globbing pattern matching &ldquo;image-name:tag&rdquo;, and <code>value</code> is the name of the file that will be placed into the booted image. Add a catch-all at the end of the file (<code>*=default_fstab</code>) to use the same <code>/etc/fstab</code> for all images.</li>
<li>Re-run the hooks after making changes with <code>darch stage run-hooks</code>.</li>
</ol>

<h2 id="hostname">hostname</h2>

<pre><code class="language-bash">darch hooks help hostname
</code></pre>

<ol>
<li>Create a <code>/var/darch/hooks/hostname.config</code> file.</li>
<li>The file is a list of <code>image-name=value</code>, similar to the fstab hook above, but where <code>value</code> represents the value that will be put into <code>/etc/hostname</code>.</li>
<li>Re-run the hooks after making changes with <code>darch stage run-hooks</code>.</li>
</ol>

<h1 id="documentation">Documentation</h1>

<p>At the moment, you should refer to the <code>darch</code> command for documentation. A wiki will eventually be created.</p>

<h1 id="going-forward">Going forward</h1>

<p>I am really happy with this solution. With future support for different distributions, users can easily tinker with Gentoo, Void Linux, and even Ubuntu.</p>

<p>I really like the approach for using Docker. It&rsquo;s inheritance made it really easy to isolate and speed up the build process. However, I don&rsquo;t like that the images are mixed together with traditional Docker images, and a daemon is required to be running to perform the build.</p>

<p>In the future, I will be using the internals of the Docker daemon directly inside of Darch.</p>

<ul>
<li>Layer store</li>
<li>Images (tagging/pushing/pulling)</li>
</ul>

<p>The layers/images/mounts will be stored in <code>/var/lib/darch</code>, it&rsquo;s own directory. A running daemon will not be required, since Darch doesn&rsquo;t actually run processes/containers. The built layers/images will be compatible with any Docker registry, including DockerHub.</p>

      </article>

      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="https://www.pknopf.com/post/2017-03-20-an_immutable_reproducible_and_inheritable_linux_operating_system/" data-toggle="tooltip" data-placement="top" title="An immutable, reproducible and inheritable Linux operating system.">&larr; Previous Post</a>
          </li>
        
        
      </ul>

      
        
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "pknopf" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
        
      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          © 2018

          
            &nbsp;&bull;&nbsp;
            <a href="https://www.pknopf.com/">Paul Knopf</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
           
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://www.pknopf.com/js/main.js"></script>
<script src="https://www.pknopf.com/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
<script src="https://www.pknopf.com/js/load-photoswipe.js"></script>



  </body>
</html>

