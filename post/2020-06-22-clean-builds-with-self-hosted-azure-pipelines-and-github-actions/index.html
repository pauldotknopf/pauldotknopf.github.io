<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Clean builds with self-hosted Azure Pipelines and GitHub Actions - Paul Knopf</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link href="/dist/styles.css" rel="stylesheet" type="text/css"/>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112478642-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-112478642-1');
  </script>
</head>
<body>
<header class="bg-light mb-5">
  <div class="navbar navbar-expand">
    <div class="container">
      <a href="/" class="navbar-brand d-flex">
        <strong>paul knopf</strong>
      </a>
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="/archive">archive</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/about">about</a>
        </li>
      </ul>
    </div>
  </div>
</header>
<main>
  
<div class="container">
    <div class="post">
        <h1 class="title">
            Clean builds with self-hosted Azure Pipelines and GitHub Actions
        </h1>
        <p class="submitted">
            posted on Jun 22, 2020
        </p>
        <div class="content">
            <p><em><strong>NOTE:</strong> I will reference Azure Pipelines going forward, but this applies to GitHub Actions as well, unless specifically stated otherwise.</em></p>
<h1 id="the-problem">The problem</h1>
<p>Running builds on Microsoft-hosted Azure Pipelines is very reproducible because every build get's a pristine environment in a disposable VM.</p>
<p>When creating a self-hosted VM, there is no guidance on having this behavior preserved. The docs instead guide you through installing the agent on an existing/mutable operating system.</p>
<h1 id="the-solution">The solution</h1>
<p>What we need to do is something like this:</p>
<ol>
<li>Create a disposable environment.</li>
<li>Start the agent in the environment.</li>
<li>Process exactly one job.</li>
<li>Stop the agent.</li>
<li>Dispose of the environment.</li>
<li>Loop back to step 1</li>
</ol>
<h1 id="disposable-environments">Disposable environments.</h1>
<p>There are multiple methods to create disposable environments.</p>
<ul>
<li>Docker
<ul>
<li>Pros:
<ul>
<li>Simple to create image.</li>
<li>Quick environment create/destroy.</li>
</ul>
</li>
<li>Cons:
<ul>
<li>Docker-in-Docker is tough.
<ul>
<li>You can mount the Docker socket into your container, but you introduce shared state between builds.</li>
<li>Mounting paths are problematic when using Docker-in-Docker.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Packer/Vagrant
<ul>
<li>Pros:
<ul>
<li>Better isolation of builds.</li>
<li>Using Docker in your builds is idiomatic.</li>
</ul>
</li>
<li>Cons:
<ul>
<li>A new tool to learn (at least in my case), Packer.</li>
<li>Microsoft has shared their scripts for provisioning their Microsoft-hosted agents, but work is needed to support anything that isn't run in Azure (qemu, VMWare, etc).</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Docker was suitable for my case, so that is what I'll focus on.</p>
<h1 id="the-implementation">The implementation</h1>
<p>When running the self-hosted agent locally, there is a hidden gem available, the <code>--once</code> flag.</p>
<pre><code>./run.sh --once
</code></pre>
<p>This flag will configure the agent to listen for exactly one job, process it, and shutdown immediately.</p>
<p>So now, let's get our agent configured to run in a Docker container. Luckily, the Microsoft docs have this covered <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/docker?view=azure-devops#linux">here</a>. BUT, there are some slight modifications we must make to allow us to utilize the <code>--once</code> flag.</p>
<pre><code class="language-diff hljs">diff --git a/Dockerfile b/Dockerfile
index 3d0c684..f1195da 100644
<span class="hljs-comment">--- a/Dockerfile</span>
<span class="hljs-comment">+++ b/Dockerfile</span>
@@ -22,4 +22,4 @@ WORKDIR /azp
 COPY ./start.sh .
 RUN chmod +x start.sh
 
<span class="hljs-deletion">-CMD ["./start.sh"]</span>
\ No newline at end of file
<span class="hljs-addition">+ENTRYPOINT ["./start.sh"]</span>
\ No newline at end of file
diff --git a/start.sh b/start.sh
index ac679c5..96f4ac5 100644
<span class="hljs-comment">--- a/start.sh</span>
<span class="hljs-comment">+++ b/start.sh</span>
@@ -92,4 +92,4 @@ print_header "4. Running Azure Pipelines agent..."
 
 # `exec` the node runtime so it's aware of TERM and INT signals
 # AgentService.js understands how to handle agent self-update and restart
<span class="hljs-deletion">-exec ./externals/node/bin/node ./bin/AgentService.js interactive</span>
\ No newline at end of file
<span class="hljs-addition">+exec ./externals/node/bin/node ./bin/AgentService.js interactive $*</span>
\ No newline at end of file
</code></pre>
<p>When you have successfully setup and patched, let's build our image.</p>
<pre><code class="language-bash hljs">docker build . --tag dockeragent</code></pre>
<p>Now we can startup the image to process exactly one build.</p>
<pre><code class="language-bash hljs"><span class="hljs-built_in">echo</span> <span class="hljs-string">"your-api-token"</span> &gt; /etc/api-token
docker run --name dockeragent \
  --rm \
  -v /etc/api-token:/api-token \
  -e AZP_URL=<span class="hljs-string">"https://dev.azure.com/your-company"</span> \
  -e AZP_POOL=<span class="hljs-string">"Pipelines"</span> \
  -e AZP_AGENT_NAME=<span class="hljs-string">"dockeragent"</span> \
  -e AZP_TOKEN_FILE=<span class="hljs-string">"/api-token"</span> \
  dockeragent:latest --once</code></pre>
<p>Ok, great, now how do I configure this to run in a loop?</p>
<p>Enter, <code>systemd</code>.</p>
<p><strong><code>/lib/systemd/system/dockeragent.service</code></strong></p>
<pre><code class="language-ini hljs"><span class="hljs-attr">AZP_URL</span>=https://dev.azure.com/your-company
<span class="hljs-attr">AZP_POOL</span>=Pipelines
<span class="hljs-attr">AZP_TOKEN_FILE</span>=/etc/api-token
</code></pre>
<p><strong><code>/lib/systemd/system/dockeragent.service</code></strong></p>
<pre><code class="language-ini hljs"><span class="hljs-section">[Unit]</span>
<span class="hljs-attr">Description</span>=Microsoft Azure docker agent
<span class="hljs-attr">Requires</span>=docker.service
<span class="hljs-attr">After</span>=docker.service
<span class="hljs-section">
[Service]</span>
<span class="hljs-attr">EnvironmentFile</span>=-/etc/default/%n
<span class="hljs-attr">ExecStart</span>=/usr/bin/docker run --name %n -e AZP_URL=<span class="hljs-variable">${AZP_URL}</span> -e AZP_POOL=<span class="hljs-variable">${AZP_POOL}</span> -e AZP_AGENT_NAME=%n -e AZP_TOKEN_FILE=<span class="hljs-variable">${AZP_TOKEN_FILE}</span> dockeragent:latest --<span class="hljs-literal">on</span>ce
<span class="hljs-attr">ExecStop</span>=/usr/bin/docker stop %n
<span class="hljs-attr">ExecStopPost</span>=-/usr/bin/docker rm -f %n
<span class="hljs-attr">Restart</span>=always
<span class="hljs-section">
[Install]</span>
<span class="hljs-attr">WantedBy</span>=default.target</code></pre>
<p>Once these files are in place, enable the <code>systemd</code> unit.</p>
<pre><code class="language-bash hljs">sudo systemctl daemon-reload
sudo systemctl start dockeragent</code></pre>
<p>Now your builds will start on boot and run over and over in a pristine/clean environment!</p>
<p>This process is similar to GitHub Actions because their runner is a fork of the Azure runner. They support running in a Docker agent with the <code>--once</code> flag.</p>

        </div>
            <hr />
            <h3>Comments</h3>
                <p class="text-muted">
                    There are no comments yet.
                </p>
            <p class="text-center">
                <a class="btn btn-primary btn-light btn-lg" target="_blank" href="https://github.com/pauldotknopf/pauldotknopf.github.io/issues/15#new_comment_field"><i class="fab fa-github"></i> Join the discussion at GitHub</a>
            </p>
    </div>
</div>
</main>
<footer class="bg-light py-3 mt-5 text-muted text-center">
  <a href="https://github.com/pauldotknopf/pauldotknopf.github.io"><i class="fab fa-github"></i> source</a>
</footer>
<script src="/dist/scripts.js"></script>
</body>
</html>
